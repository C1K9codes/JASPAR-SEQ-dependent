```{r setup, include=FALSE}
# Load libraries
library(TFBSTools)
library(JASPAR2022)  # or JASPAR2024 if installed
library(Biostrings)
library(dplyr)
library(knitr)
library(kableExtra)

# Replace with your EGFR DNA sequence
EGFR_gene <- DNAString("ATGCGT...")  

opts <- list(species = 9606, collection = "CORE")
PFMatrixList <- getMatrixSet(JASPAR2022, opts)

results_list <- lapply(names(PFMatrixList), function(tf_id) {
  
  pwm <- toPWM(PFMatrixList[[tf_id]], type="log2probratio")
  hits <- searchSeq(pwm, EGFR_gene, min.score="80%", seqname="EGFR")
  
  if(length(hits) > 0) {
    df <- as.data.frame(hits)
    df$TF_ID <- tf_id
    return(df)
  } else {
    return(NULL)
  }
})

# Remove empty elements
results_list <- results_list[!sapply(results_list, is.null)]

# Combine into a single data frame
all_hits <- bind_rows(results_list)

# Map TF_ID to TF_name
tf_names <- sapply(PFMatrixList[names(PFMatrixList)], name)
all_hits$TF_name <- tf_names[all_hits$TF_ID]

# Convert relScore and absScore to numeric
all_hits$relScore <- as.numeric(unlist(all_hits$relScore))
all_hits$absScore <- as.numeric(unlist(all_hits$absScore))

high_conf_hits <- all_hits %>% filter(relScore >= 0.85)

top_TFs <- high_conf_hits %>%
  group_by(TF_name) %>%
  summarize(max_relScore = max(relScore), nHits = n()) %>%
  arrange(desc(max_relScore), desc(nHits))

# Title in PDF
cat("\n# EGFR TFBS Hits Analysis\n")
cat(paste("Generated by: Your Name\n"))
cat(paste("Date:", Sys.Date(), "\n\n"))

# High-confidence hits table
kable(high_conf_hits, format = "latex", booktabs = TRUE, 
      caption = "High-Confidence TF Motif Hits in EGFR") %>%
  kable_styling(latex_options = c("scale_down", "hold_position"))

# Top TFs ranking table
kable(top_TFs, format = "latex", booktabs = TRUE, 
      caption = "Top TFs by Score and Hits") %>%
  kable_styling(latex_options = c("scale_down", "hold_position"))

# Optional: save CSV for GitHub
write.csv(all_hits, "EGFR_all_TFBS_hits.csv", row.names=FALSE)
write.csv(high_conf_hits, "EGFR_high_conf_TFBS.csv", row.names=FALSE)
write.csv(top_TFs, "EGFR_TF_ranking.csv", row.names=FALSE)


